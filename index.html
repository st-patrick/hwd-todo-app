<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">

    <meta name="theme-color" content="lightgoldenrodyellow">
    <meta name="theme-color" content="lightgoldenrodyellow" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="lightgoldenrodyellow" media="(prefers-color-scheme: dark)">
	
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
	<meta name="viewport" content="minimal-ui">
	<meta name="viewport" content="initial-scale=1"> 
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"> 
	<meta name="mobile-web-app-capable" content="yes">
	<link rel="manifest" href="/app.webmanifest">

    <style>
		:root {
			/* blue goofy theme
			--input-padding: .5rem 1.5rem;
			--input-background: cornflowerblue;
			--input-weight: 500;
			--input-size: 1.1rem;
			--input-color: white;
			--background: lightgoldenrodyellow;
			*/
		  
			/* gray serious theme */
			--input-padding: .7rem 1rem .8rem 1rem;
			--input-background: lightgray;
			--input-weight: 490;
			--input-size: 0.85rem;
			--input-color: black;
			--background: white;
		}
	
		body::-webkit-scrollbar{
			display: none;
		}
		textarea::-webkit-scrollbar{
			display: none;
		}
	
        .todo-input {
        }

        .btn-primary {
            background-color: #b1c9fe;
            border-color: #b1c9fe;
            color: #438594;
        }

        .ios-peek {
            position: fixed;
            z-index: -1;
            bottom: 0;
            left: 0;
            background: var(--background);
            height: 100vh;
            width: 100vw;
        }

        textarea {
            height: 200px;
        }
		
		.form-control {
			padding: var(--input-padding);
			font-size: var(--input-size);
			font-weight: var(--input-weight);
			color: var(--input-color);
			background-color: var(--input-background);
			border: none;
			border-radius: .55rem;
			transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
		}
		
		.heading {
			font-weight: bold;
		}
		
		.textarea-highlighter {
			height: 33px;
			background: red;
			z-index: 99999999;
			margin-bottom: -33px;
			position: relative;
			mix-blend-mode: plus-lighter;
		}
		
		.project-highlighter {
			height: 44px;
			position: absolute;
			width: 44px;
			background: red;
			mix-blend-mode: color;
		}
		
		/*
		
		colors that work well for mix-blend-mode: color
		#b94
		#1cee
		#153f
		#838
		
		*/

    </style>

    <title>ToolDo</title>
</head>
<body style="background: var(--background);">

    <div class="container mt-3 mb-5">
        <div class="row">
            <div class="col-12 offset-md-1 col-md-10 offset-lg-0 col-lg-6 col-xxl-4 mb-3">
                <p class="heading">Projects</p>
                <div id="project-list" class="mb-2">
                    <input class="form-control mb-2 project-input" type="text">
                    <input class="form-control mb-2 project-input" type="text">
                    <input class="form-control mb-2 project-input" type="text">
                    <input class="form-control mb-2 project-input" type="text">
                    <input class="form-control mb-2 project-input" type="text">
                </div>
                <div class="mb-2 text-center">
                    <span class="fw-bold pb-3" onclick="addProject();">+ Add Project</button>
                </div>
            </div>
            <div class="col-12 offset-md-1 col-md-10 offset-lg-0 col-lg-6 col-xxl-4 mb-3">
                <p class="heading">ToDos</p>
                <div id="list">
                    <input class="form-control mb-2 todo-input" type="text">
                    <input class="form-control mb-2 todo-input" type="text">
                    <input class="form-control mb-2 todo-input" type="text">
                    <input class="form-control mb-2 todo-input" type="text">
                    <input class="form-control mb-2 todo-input" type="text">
                    <input class="form-control mb-2 todo-input" type="text">
                </div>
                <div class="mb-2 text-center">
                    <span class="fw-bold pb-3" onclick="addTodo();">+ Add ToDo</span>
                    
                </div>
                <br class="d-none d-xxl-block">
                <div class="d-none d-xxl-block text-center fw-bold" id="count" style="color: white;">
                    0
                </div>
                <br class="d-none d-xxl-block">
                <div class="d-none d-xxl-block" id="done">
                    hwd DONE something...
                </div>
                <div class="d-none d-xxl-block text-center fw-bold" id="countDone" style="color: white;">
                    0
                </div>
            </div>
            <div class="col-12 offset-md-1 col-md-10 offset-lg-0 col-lg-6 col-xxl-4 mb-3">
                <p class="heading">Breakdown</p>
                <div id="breakdown-list">
                    <textarea class="form-control mb-2 breakdown-input" type="text"></textarea>
                    <textarea class="form-control mb-2 breakdown-input" type="text"></textarea>
                </div>
                <div class="mb-2 text-center">
                    <span class="fw-bold pb-3" onclick="addBreakdown();">+ Add Breakdown</span>
                </div>
            </div>
        </div>


        <br><br><br>

        <button id="save-button"
				class="btn btn-lg pt-2 pb-3 px-3 text-white position-fixed"
                style="
					background-color: #00000055;
					backdrop-filter: blur(5px);
					box-shadow: .1rem .1rem 0.1rem 0px black!important;
					right: 5px;
					border-radius: 5px;
					bottom: 10px;
					z-index: 9;"
                onclick="saveAll();">
							
			<svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-server" viewBox="0 0 16 16">
			  <path d="M1.333 2.667C1.333 1.194 4.318 0 8 0s6.667 1.194 6.667 2.667V4c0 1.473-2.985 2.667-6.667 2.667S1.333 5.473 1.333 4V2.667z"/>
			  <path d="M1.333 6.334v3C1.333 10.805 4.318 12 8 12s6.667-1.194 6.667-2.667V6.334a6.51 6.51 0 0 1-1.458.79C11.81 7.684 9.967 8 8 8c-1.966 0-3.809-.317-5.208-.876a6.508 6.508 0 0 1-1.458-.79z"/>
			  <path d="M14.667 11.668a6.51 6.51 0 0 1-1.458.789c-1.4.56-3.242.876-5.21.876-1.966 0-3.809-.316-5.208-.876a6.51 6.51 0 0 1-1.458-.79v1.666C1.333 14.806 4.318 16 8 16s6.667-1.194 6.667-2.667v-1.665z"/>
			</svg>
				
		</button>
    </div>

    <div class="ios-peek">
    </div>

</body>
<!-- Option 1: Bootstrap Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>

<script>

    let globalList = [];
    let globalBreakdownList = [];
    let globalProjectList = [];
    let globalTodoCount = 0;
    let globalDoneCount = 0;
	
	// other helpers
	const randomColor = () => Math.floor(Math.random()*16770).toString(16);
	
	//templates
	const todoTemplate = (name) => `
		<div class="position-relative">
			<input class="form-control mb-2 todo-input" type="text" placeholder="type here" value="${name}">
			<span class="position-absolute top-50 translate-middle badge" style="
				right: -19px;
				background-color: #` + randomColor() + `;
				mix-blend-mode: hard-light;
				backdrop-filter: blur(3px);
				padding-bottom: 7px;
			">Finance</span>
		</div>`;
		

	

    async function getJSONdata() {
        const request = new Request('https://api.npoint.io/09f00b9000d1a3a5902a', {method: 'GET'});

        return await thatFetchStuff(request);
    }

    async function thatFetchStuff(request) {
        let responseObject = "connection failed"; // default to error, will be replaced by data

        await fetch(request)
            .then(response => {
                if (response.status === 200) {
					console.log(response);
                    return response.json();
                } else {
					console.log("response not 200");
					return "result not 200";
                    throw new Error('Something went wrong on api server!');
                }
            })
            .then(response => {
                responseObject = response;
                // ...
            }).catch(error => {
				
                console.error(error);
            });

        return responseObject;
    }

    async function main() {
        let response = await getJSONdata();
        globalList = response.list;
        globalBreakdownList = response.breakdowns;
        globalProjectList = response.projects;
        scoreSortRender();
    }

    function sortTodos() {
        getTodosFromInputs();
        scoreSortRender();
    }

    function scoreSortRender(){
        scoreTodos();
        globalList = globalList.sort(compareTodoScore);
        renderAll();
    }

    /* was not really necessary, we now work with the globallist object
    function convertToOnlyNames(objectList) {
        let listOnlyNames = [];
        for(let todo of objectList) {
            listOnlyNames.push(todo.name);
        }
        return listOnlyNames;
    }  */

    function addTodo(){
        let listDOM = document.getElementById('list');
        let content = todoTemplate("");
        listDOM.insertAdjacentHTML('beforeend', content);
    }

    function addBreakdown() {
        let listDOM = document.getElementById('breakdown-list');
        let content = `<div class="textarea-highlighter"></div><textarea class=\"form-control mb-2 breakdown-input\" type=\"text\"></textarea>`;
        listDOM.insertAdjacentHTML('beforeend', content);
    }

    function addProject() {
        let listDOM = document.getElementById('project-list');
        let content = `<div class="project-highlighter"></div><input class=\"form-control mb-2 project-input\" type=\"text\">`;
        listDOM.insertAdjacentHTML('beforeend', content);
    }


    async function renderTodos() {
        let listDOM = document.getElementById('list');
        let listHTML = "";

        let doneDOM = document.getElementById('done');
        let doneHTML = "";

        for(let todo of globalList) {

            if (todo.score < 0) {
                doneHTML += "<p>" + todo.name + "</p>";
            } else {
                listHTML += todoTemplate(todo.name);
            }

        }

        listDOM.innerHTML = listHTML;
        doneDOM.innerHTML = doneHTML;

        document.getElementById('count').innerHTML = globalTodoCount;
        document.getElementById('countDone').innerHTML = globalDoneCount;
    }

    async function renderProjects() {
        let listDOM = document.getElementById('project-list');
        let listHTML = "";
        for(let item of globalProjectList) {
            listHTML += `<div class="project-highlighter" style="background: #`+ randomColor() +`;"></div><input class=\"form-control mb-2 project-input\" type=\"text\"  value=\"` + item.name + `\" >`;
        }
        listDOM.innerHTML = listHTML;
    }

    async function renderAll() {
        renderTodos();
        renderProjects();

        let listDOM = document.getElementById('breakdown-list');
        let listHTML = "";

        for(let breakdown of globalBreakdownList) {
            listHTML += `<div class="textarea-highlighter" style="background: #`+ randomColor() +`;"></div><textarea class=\"form-control mb-2 breakdown-input\" type=\"text\">` + breakdown + `</textarea>`;
        }

        listDOM.innerHTML = listHTML;
    }

    /*
     * assigns each ToDo a score based on the first letters code
     */
    function scoreTodos() {

        globalDoneCount = 0;
        globalTodoCount = 0;

        for(let todo of globalList) {

            if(todo.name.includes("DONE")) {

                todo.score = -1;
                globalDoneCount++;

            } else {

                let highImpact = todo.name.charAt(0);
                let importance = todo.name.charAt(1);
                let urgency = todo.name.charAt(2);

                if (highImpact != '-') {
                    highImpact = 100;
                } else { highImpact = 0; }
                if (importance != '-') {
                    importance = 10;
                } else { importance = 0; }
                if (urgency != '-') {
                    urgency = 1;
                } else { urgency = 0; }

                todo.score = highImpact + importance + urgency;
                globalTodoCount++;

            }

        }

    }

    function compareTodoScore(a, b) {
        return b.score - a.score;
    }

    function getTodosFromInputs() {
        const todoInputs = document.getElementsByClassName("todo-input");
        const dones = document.getElementById("done").getElementsByTagName("p");
        globalList = [];
        for(let todo of todoInputs) {
            if(todo.value != "") {
                globalList.push({name: todo.value});
            }
        }
        for(let done of dones) {
            if(done.innerHTML != "") {
                globalList.push({name: done.innerHTML});
            }
        }
    }

    function getProjectsFromInputs() {
        const inputs = document.getElementsByClassName("project-input");
        globalProjectList = [];
        for(let input of inputs) {
            if(input.value != "") {
                globalProjectList.push({name: input.value});
            }
        }
    }

    function getDataFromInputs() {
        getTodosFromInputs();

        const breakdowns = document.getElementsByClassName("breakdown-input");
        globalBreakdownList = [];
        for(let breakdown of breakdowns) {
            if(breakdown.value != "") {
                globalBreakdownList.push(breakdown.value);
            }
        }
    }
    

    async function saveDataFrom(area) {
        if (area == "todos") {
            getTodosFromInputs();

            const body = {list: globalList};
            const bodyJSON = JSON.stringify(body);

            const request = new Request('https://api.npoint.io/09f00b9000d1a3a5902a', {
                method: 'POST',
                body: bodyJSON,
                headers: {'Authorization': 'Bearer PhKqhyh2LEhtBbRPLABwB7pq'}
            });

            thatFetchStuff(request);
        } else if (area == "projects") {

        }
    }

    // saves all data from the app instead of just one area
    // first, get the data from the html inputs
    // then, send them as a json object to our storage provider
    async function saveAll() {
		// indicate processing of save data ...
		saveButton = document.getElementById('save-button');
		saveButton.innerHTML = "..."
	
        getDataFromInputs();
        getProjectsFromInputs();
		sortTodos();

        const body = {
            list: globalList,
            breakdowns: globalBreakdownList,
            projects: globalProjectList
        };
        const bodyJSON = JSON.stringify(body);

        const request = new Request('https://api.npoint.io/09f00b9000d1a3a5902a', {
            method: 'POST',
            body: bodyJSON,
            headers: {'Authorization': 'Bearer PhKqhyh2LEhtBbRPLABwB7pq'}
        });

        const response = await thatFetchStuff(request);
		if (response == "result not 200" || response == "connection failed") {
			saveButton.style.backgroundColor = "red";
			saveButton.innerHTML = "not saved";
		} else {
			saveButton.style.backgroundColor = "green";
			saveButton.innerHTML = "saved";
			setTimeout(() => { 
					saveButton.outerHTML = `
        <button id="save-button"
				class="btn btn-lg pt-2 pb-3 px-3 text-white position-fixed"
                style="
					background-color: #00000055;
					backdrop-filter: blur(5px);
					box-shadow: .1rem .1rem 0.1rem 0px black!important;
					right: 5px;
					border-radius: 5px;
					bottom: 10px;
					z-index: 9;"
                onclick="saveAll();">
							
			<svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-server" viewBox="0 0 16 16">
			  <path d="M1.333 2.667C1.333 1.194 4.318 0 8 0s6.667 1.194 6.667 2.667V4c0 1.473-2.985 2.667-6.667 2.667S1.333 5.473 1.333 4V2.667z"/>
			  <path d="M1.333 6.334v3C1.333 10.805 4.318 12 8 12s6.667-1.194 6.667-2.667V6.334a6.51 6.51 0 0 1-1.458.79C11.81 7.684 9.967 8 8 8c-1.966 0-3.809-.317-5.208-.876a6.508 6.508 0 0 1-1.458-.79z"/>
			  <path d="M14.667 11.668a6.51 6.51 0 0 1-1.458.789c-1.4.56-3.242.876-5.21.876-1.966 0-3.809-.316-5.208-.876a6.51 6.51 0 0 1-1.458-.79v1.666C1.333 14.806 4.318 16 8 16s6.667-1.194 6.667-2.667v-1.665z"/>
			</svg>
				
		</button>					
					`; 
				}, 2000);
		}
		
		console.log("asasfdsaf")
		console.log(response);
    }

    // add listener for CTRL+S save shortcut
    document.addEventListener('keydown', e => {
        if (e.ctrlKey && e.key === 's') {
            // Prevent the Save dialog to open
            e.preventDefault();
            // Place your code here
            console.log('CTRL + S');
            saveAll();
        }
    });

    main();




</script>

</html>